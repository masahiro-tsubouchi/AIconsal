# 公式に合わせたリファクタリング計画

- バージョン: 1.0.1
- 作成日: 2025-08-31
- 最終更新: 2025-09-03
- 対象: Backend（LangGraphベースのワークフロー）
- 想定読者: 開発者・レビュアー

## 目次
- 目的
- 現状サマリ
- 進捗状況
- 公式に基づく改善ポイント
- 実施手順（フェーズ）
- グラフ可視化の実行方法（Docker推奨）
- Debug/Trace モード（公式準拠）
- 受け入れ基準
- 変更対象の主なファイル/ディレクトリ
- 参考リンク（LangGraph 公式）
- ロールバック戦略
- メモ
- 付録A: エージェントI/O移行計画

## 目的
LangGraph 公式ドキュメントに準拠した形で、拡張性（追加容易性）と視認性（可観測性・可視化の正確性）を高める。

## 現状サマリ
- エージェント: `backend/app/services/agents/` に 1ファイル=1エージェントを分離済み
  - `manufacturing_advisor.py`, `python_mentor.py`, `general_responder.py`
- LangGraph サービス: `langgraph_service.py` から上記エージェントへ委譲
- ツール: `backend/app/services/tools/` に分離、`detect.py`/`registry.py`/`sql.py`/`web.py`
- 統合テスト: Docker 内で 11/11 PASS（既存挙動維持）

## 進捗状況

- 完了
  - 可視化: `export_mermaid()` を `get_graph().draw_mermaid()` へ移行（手動定義フォールバック維持）
  - エージェントI/F: `agents/types.py`（`AgentInput/Output`）＋ `agents/registry.py` 追加、サービスからレジストリ解決
  - ツールI/F: `ToolResult` 追加、`async_execute_tool()` によるタイムアウト/例外の構造化（`tools/registry.py`）
  - 状態管理: `messages: Annotated[list, add_messages]` を導入し、`user/assistant` を各終端ノードで追加
  - Durable: `Settings.enable_checkpointer` による `MemorySaver` 条件導入、`thread_id` を `ainvoke(configurable)` に伝播
  - PNG: `export_mermaid_png()`（ビルトイン）を追加し、`scripts/generate_graph_assets.sh` でビルトイン優先→Docker Mermaid CLI へフォールバック
  - ログ/相関ID: `thread_id`/`agent`/`tool` を `structlog` で各ノード・エラーに bind して一貫出力。`ManufacturingState` に `thread_id` を追加して状態として伝播。
  - テスト（Docker内ユニット）: messages reducer、async tools（timeout/error）、Durable（checkpointer+thread_id）スモーク、ログ相関ID（thread_id/agent/tool）の計5本を追加し PASS。
  - 命名整理: `ManufacturingState` → `WorkflowState` に移行（コード内は `WorkflowState` に統一、`ManufacturingState = WorkflowState` のエイリアスで後方互換維持）
  - ドキュメント: `README.md` に Docker内テスト手順を拡充（`docker compose` 併記、開発ループ向け `--no-cov` の案内を追加）。
  - ドキュメント: `docker-compose.yml` に `ENABLE_CHECKPOINTER` のサンプル（コメント）を記載、`README.md` にも案内を追記。
  - テスト（Docker内統合）: Chat API のデバッグモード検証（`tests/integration/test_api_debug.py`）を追加し PASS。
  - 実行確認: Docker backend 内で全テスト 26/26 PASS（開発ループ用に `--no-cov` を使用）。
  - エージェントI/O段階導入: `general_responder` に続き `python_mentor` と `manufacturing_advisor` に `run_v2(AgentInput)->AgentOutput` を追加。既存 `run()` はラッパーで後方互換を維持。`registry._REGISTRY_V2` に `general/python/manufacturing` を登録。`LangGraphService` は `python/manufacturing` でも v2 を優先して利用。
  - ログ: v2 実装に `agent_io_version="v2"` を付与。
  - ドキュメント: 本書に「get_agent_v2 の使用とサービス側の段階的切替」を追記。
  - Pytest設定: `pytest.ini` のセクションを `[pytest]` に修正し設定反映。`--cov-config=.coveragerc` を追加（後述のカバレッジ調整用）。
  - スクリプト: `scripts/run_integration_tests.sh` に `NO_COV=1` トグルを追加し、開発ループでカバレッジを無効化可能に。
  - テスト: ツール未認識時のログ（`tool_not_recognized`）検証テストを追加（`backend/tests/test_logging_correlations.py`）し PASS。

  - フロントエンド: Debugモード時の `[DEBUG]` ヘッダー抽出と可視表示を `frontend/src/components/MessageList/MessageItem.tsx` に実装。ヘッダー行はUIで強調表示し、本文Markdownはヘッダーを除いて描画。コピー機能は元の全文（ヘッダー含む）を保持。
  - テスト（フロント）: `frontend/src/components/__tests__/MessageItem.test.tsx` にUIテストを追加し、`[DEBUG]` ヘッダーの可視表示、本文描画、コピー内容（ヘッダー含む）を検証。`frontend/src/setupTests.ts` の `react-markdown` モックをテストフレンドリーに拡張。Docker内実行で 27/27 PASS。
  - ドキュメント: `README.md` にデバッグモードのUI挙動と CI 向けフロントエンドテスト実行コマンド（`docker compose run --rm -e CI=true frontend npm test -- --watchAll=false`）を追記。

- 課題/進行中
  - カバレッジ: 81.9%（`backend/tests/test_tools_coverage.py` 追加等で達成）。CIで `--cov-fail-under=80` を用いて維持。
  - エージェントI/O: 全エージェントで v2（`run_v2(AgentInput)->AgentOutput`）適用済み。旧I/Fは互換ラッパーとして暫定維持（次のクリーンアップで撤去予定）。
  - Lint: 既知の未解決なし（`chat_service.py` の未使用 `uuid4` は現行では存在しないため記述を削除）。

- 次のステップ
  - ドキュメント: Chat API デバッグモードのサンプルを ChatResponse 構造（`message` オブジェクト + `debug`）に合わせて更新（本書に反映済み）。
  - CI最適化（任意）: バックエンド全テスト（Docker・カバレッジ閾値80）とグラフエクスポート検証をワークフローに追加。
  - クリーンアップ（任意）: 旧I/Fラッパーの撤去タイミングを決定し、移行ガイド/CHANGELOGを更新。

## 公式に基づく改善ポイント
1. 可視化の一貫性（Mermaid のビルトイン利用）
   - 公式: `app.get_graph().draw_mermaid()` を推奨
   - 目的: グラフ定義と可視化のズレを防止
2. エージェントの標準I/F（Protocol + 型）
   - `AgentInput`/`AgentOutput`（Pydantic推奨）と `Agent` Protocol を導入
   - レジストリ `agents/registry.py` で名前→実装を解決
3. ツールの将来拡張（非同期・タイムアウト・構造化結果）
   - `async_execute_tool()` と `ToolResult`（`tool`, `input`, `output`, `took_ms`, `error?`）
4. 状態管理の強化（Reducer）
   - `messages: Annotated[list, add_messages]` で会話履歴を蓄積（段階移行）
5. Durable Execution（Checkpointer）
   - `compile(checkpointer=...)` ＋ `thread_id` 運用（長時間/失敗復帰/HITLに備える）
6. ロギング/トレーシングの強化
   - `request_id`/`session_id`/`agent`/`tool` など相関ID付帯
7. PNG生成の選択肢（任意）
   - `draw_mermaid_png()` によるCI単純化（現行のDocker版は継続可）
8. 命名の明確化（任意・段階的）
   - `ManufacturingState` → `WorkflowState`（エイリアス→置換）

## 実施手順（フェーズ）
### フェーズ1: 可視化の公式準拠（低リスク・先行）
- 修正: `LangGraphService.export_mermaid()` をビルトイン優先へ
  ```python
  def export_mermaid(self) -> str:
      try:
          return self._workflow.get_graph().draw_mermaid()
      except Exception:
          # 手動定義フォールバック（後方互換用）
          return "\n".join([...])
  ```
- スクリプト: `scripts/export_graph.py` は `service.export_mermaid()` を呼ぶため変更不要
- 受け入れ基準: 統合テスト PASS、`docs/graph.mmd` が最新トポロジと一致

### グラフ可視化の実行方法（Docker推奨）
- 推奨: Docker上の backend コンテナ内で実行してください。

1) ワンコマンド（MermaidとPNGの両方生成）
```bash
sh scripts/generate_graph_assets.sh
```

2) 手動でMermaid生成のみ（backendコンテナ内実行）
```bash
docker compose up -d backend
docker compose exec -T backend python -c "from app.services.langgraph_service import LangGraphService; print(LangGraphService().export_mermaid())" > docs/graph.mmd
```

3) `scripts/export_graph.py` をコンテナ内で直接実行
```bash
docker compose exec -T backend python /app/scripts/export_graph.py
```

4) ローカル環境での代替（開発向け）
```bash
python3 -m venv .venv && source .venv/bin/activate
pip install -r backend/requirements.txt
python scripts/export_graph.py
```
注意: ローカル実行では依存関係（例: structlog）が必要です。Dockerを利用すると依存差異による失敗を避けられます。

### フェーズ2: エージェントI/F + レジストリ（中）
- 追加: `agents/types.py`（`AgentInput/Output` + Protocol）
- 追加: `agents/registry.py`（名前→エージェント解決）
- 更新: `langgraph_service.py` の `_process_*` はレジストリ経由で解決
- テスト: プロンプト生成/フォールバックのユニットテスト

### フェーズ3: ツール非同期化 + 構造化結果（中）
- 追加: `ToolResult`、`async_execute_tool()`、タイムアウト/例外の明示
- 更新: `_process_tool_query()` に `ToolResult` の扱いを導入
- テスト: タイムアウト/エラー経路のユニットテスト

### フェーズ4: 状態・耐障害性・可観測性（低〜中）
- 状態: `messages: Annotated[list, add_messages]`（段階移行）
- Durable: `MemorySaver` などのチェックポインタ導入（任意）
- ログ: 相関IDの全体付帯（agents/tools/service）
- PNG: 必要なら `draw_mermaid_png()` に切替（任意）

### Durable Execution 有効化（任意）
- 設定: `.env` または環境変数で `ENABLE_CHECKPOINTER=true` 相当（`Settings.enable_checkpointer`）。
- 実装: `LangGraphService._build_workflow()` で `workflow.compile(checkpointer=MemorySaver())` を条件付き適用。
- 呼出: `process_manufacturing_query(..., thread_id=session_id)` のように `thread_id` を `ainvoke(config={"configurable": {"thread_id": ...}})` に伝播。
- 目的: 長時間処理・再開・HITL（人間介在）に備えた耐障害性の向上。

### PNG 生成フロー（CI/ローカル共通）
- スクリプト: `scripts/generate_graph_assets.sh`
- 手順: 
  1) Mermaid（`.mmd`）は backend コンテナ内で `LangGraphService.export_mermaid()` を実行して生成
  2) PNG はまず backend コンテナ内で `export_mermaid_png()`（ビルトイン）を試行
  3) 失敗または空出力の場合のみ Docker の Mermaid CLI (`render_graph_png.sh`) にフォールバック
- 目的: 公式のビルトインレンダラを優先してグラフの実体と整合を取りつつ、環境依存で失敗しても確実に PNG を得る

### フェーズ5: Debug/Trace モード（公式準拠）

- 目的: UIの設定でON時、回答チャットの冒頭に「どのエージェント/ツールを選択し、何を根拠に判断したか」を表示する。OFF時は既存と同じ挙動。
- 公式準拠: LangGraphの可観測性ガイドに沿い、`graph.stream()` によるイベント購読と `state` へのトレース蓄積、`structlog` 相関IDでの構造化ログを併用。

- バックエンド設計（概要）
  - `WorkflowState` に観測用フィールドを追加（例）
    - `debug: bool = False`
    - `decision_trace: list[TraceEvent] = []`
  - `TraceEvent` 例（最小）
    ```json
    {"type":"agent_selected","name":"manufacturing_advisor","reason":"製造関連の語彙を多数検出","ts": 1725235200000}
    {"type":"tool_invoked","name":"web","input":"query...","took_ms":120,"error":null}
    ```
  - 記録ポイント
    - エージェント選択時（`agents/registry.py` or `langgraph_service.py` の分岐）で `agent_selected` を `decision_trace` に追加
    - ツール検出/実行時（`tools/detect.py`, `tools/registry.py`）で `tool_invoked` を追加（`ToolResult` の `tool/input/took_ms/error` を流用）
    - `debug=True` の時のみ `graph.stream()` を使って `node_start/node_end/tool` イベントを逐次 `decision_trace` に反映
  - ログ（`structlog`）
    - 既存の `thread_id/agent/tool` に加えて `debug=True` とイベント種別を出力

- API I/F（`app/api/v1/chat.py` を想定）
  - リクエスト（例）
    ```json
    {"message":"...","session_id":"...","debug":true}
    ```
  - レスポンス（debug=trueの時のみ `debug` を同梱）
    ```json
    {
      "message": {
        "id": "f1a2b3c4-....-9d0e",
        "session_id": "abc-123",
        "content": "[DEBUG] Agent: general_responder / Tool: none / 根拠: LLM分類結果\n\n回答本文...",
        "role": "assistant",
        "timestamp": "2025-09-03T12:34:56.789Z",
        "file_ids": [],
        "processing_time": 0.123
      },
      "session_id": "abc-123",
      "processing_time": 0.123,
      "debug": {
        "thread_id": "abc-123",
        "display_header": "Agent: general_responder / Tool: none / 根拠: LLM分類結果",
        "selected_agent": "general_responder",
        "selected_tool": null,
        "decision_trace": [
          {"type":"agent_selected","name":"general_responder","reason":"LLM分類結果","ts": 1725350000000}
        ]
      }
    }
    ```
  - `display_header` はフロントでそのまま先頭に表示可能な短文。生成はサービス層（`langgraph_service.py`）で実施。

- フロントエンド仕様（任意）
  - 設定トグル: 「表示設定 > デバッグ/トレース情報」
  - ON時の表示: アシスタントメッセージの冒頭に `debug.display_header` をバッジ/小見出しとして表示
  - 実装ポイント: `frontend/src/components/` のチャット気泡コンポーネントで条件表示（既存WS/RESTは変更なし）

### 実装メモ（現状）
- フロントエンドは現時点でバックエンドが `message.content` 先頭に付与する `[DEBUG] {display_header}` 行を検出し、UIヘッダーとして強調表示しています。
- コピーは元のメッセージ全文（ヘッダー含む）を保持するため、ユーザーがクリップボードへコピーした際にデバッグ情報も含まれます。
- 代替案（将来改善）: `ChatResponse.debug` の `display_header` から直接レンダリングする方式へ段階移行すると、UIロジックが明確になります（ヘッダー行のパースに依存しない）。

- 受け入れ基準（Phase5）
  - 既定（debug=false）では挙動・レスポンスは不変
  - debug=true で `debug.display_header` と `decision_trace` が返る
  - 構造化ログに `agent_selected`/`tool_invoked` が相関ID付きで出力

- テスト
  - ユニット: サービス層で `debug=True` の場合に `decision_trace` と `display_header` が生成されること
  - 統合(API): `debug=true` で `display_header` を含むJSONが返ること（代表ルート: 製造系→`manufacturing_advisor`）

- スケジュール目安
  - 0.5〜1日: サービス/レジストリ/ツールに記録処理を追加 + APIの `debug` 対応 + テスト

## 受け入れ基準
- 既存統合テスト（11件）および追加ユニットテストが全て PASS
- 可視化（Mermaid/PNG）がグラフの実体と常に一致
- 新規エージェント/ツール追加が最小差分で完結（レジストリ/型に準拠）

## 変更対象の主なファイル/ディレクトリ
- `backend/app/services/langgraph_service.py`
- `backend/app/services/agents/`（`types.py`, `registry.py`, 既存エージェント）
- `backend/app/services/tools/`（`ToolResult`, 非同期化）
- `scripts/export_graph.py`（基本変更不要）

## 参考リンク（LangGraph 公式）
- Graph API 可視化（Mermaid/PNG）: 
  - https://langchain-ai.github.io/langgraph/how-tos/graph-api/ （Visualize your graph）
- State / Reducer / TypedDict: 
  - https://langchain-ai.github.io/langgraph/how-tos/graph-api/ （Define and update state）
- Durable Execution / Persistence / Checkpoints: 
  - https://langchain-ai.github.io/langgraph/concepts/durable_execution/
  - https://langchain-ai.github.io/langgraph/concepts/persistence/
  - https://langchain-ai.github.io/langgraph/reference/checkpoints/

## ロールバック戦略
- すべて段階導入・後方互換ラッパーを維持
- 問題発生時は該当フェーズの変更のみ巻き戻し

## メモ
- 現行構成はすでに良好。上記は中長期の保守性/拡張性/視認性向上が目的

## 付録A: エージェントI/O移行計画

### 概要
- 目的: `AgentInput`/`AgentOutput` を安全に導入し、互換レイヤを維持しつつ段階的に展開。全テスト合格後に旧I/Fを完全置換。
- 範囲: `backend/app/services/agents/` 配下（`general_responder.py` / `python_mentor.py` / `manufacturing_advisor.py`）、`agents/registry.py`、`LangGraphService.*` 呼び出し箇所。

### ステップ
1) パイロット導入（general_responder）
   - 実装: `run(llm, inp: AgentInput) -> AgentOutput` を追加。
   - 互換: 旧署名（`run(llm, user_query, conversation_history, file_context) -> str`）はレジストリでラップし維持。
   - ログ: `agent_io_version=v2` などのメタを `structlog` に付与。
   - テスト: 正常/異常・型検証・ログ相関（`thread_id/agent/tool`）をユニットで追加。

2) サービス対応（呼び出し点の最小変更）
   - `LangGraphService._process_*` で `AgentInput` を組み立て、戻り値は `AgentOutput.content` を使用。
   - 既存の応答テキストは不変を目標（差分はレビュー基準で許容範囲を定義）。
   - 統合テストを更新・追加。

3) 展開（順次適用）
   - `python_mentor` → `manufacturing_advisor` の順で新I/Fへ移行。
   - レジストリは新I/Fを優先しつつ、旧I/Fはラップで後方互換を維持。
   - ドキュメント（README/設計）を更新。

4) フリーズ & 最終置換（全テスト合格後）
   - 互換レイヤを削除し、旧I/F（旧 `AgentFn`）を完全廃止。
   - `agents/types.py` の `AgentFn` を新署名に統一、`agents/registry.py` の旧経路を撤去。
   - 型チェック（mypy）、リンタ、ユニット/統合/回帰テストの全てが PASS。

5) 移行完了
   - バージョンタグ付与、CHANGELOG 追記、開発者向けアナウンスを実施。

### 追加の受け入れ基準（I/O移行）
- 既存 API の挙動は後方互換（応答テキスト差分はレビューで許容範囲内）。
- ログ/メトリクスの破壊的変更なし（フィールド追加は可）。
- 新旧I/F混在期間における全主要フローの統合テストが PASS。

### ロールバック指針（補足）
- 互換レイヤを保持したコミットへリバート可能なよう、段階ごとにマイルストーンコミット/タグを作成。
- 問題発生時はレジストリを旧I/F優先に切替、影響範囲を最小化。

### get_agent_v2 の使用とサービス側の段階的切替（追加）

- 目的: 新I/F（`AgentInput`/`AgentOutput`）を優先しつつ、未移行時は旧I/Fにフォールバックする安全な切替を実現。
- レジストリ: `agents/registry.py` にて v2 レジストリ `_REGISTRY_V2` を用意。
  - 現在の登録状況: `general` / `python` / `manufacturing` の3エージェントで `run_v2` を登録済み。
- サービス側の利用例（`langgraph_service.py`）:

```python
from app.services.agents.registry import get_agent, get_agent_v2
from app.services.agents.types import AgentInput

agent_v2 = get_agent_v2("python")
if agent_v2 is not None:
    inp = AgentInput(
        user_query=state['user_query'],
        conversation_history=state['conversation_history'],
        file_context=state['file_context'],
    )
    out = await agent_v2(self._llm, inp)
    state['response'] = out.content
else:
    agent = get_agent("python") or python_mentor.run
    state['response'] = await agent(
        self._llm,
        state['user_query'],
        state['conversation_history'],
        state['file_context'],
    )
```

- ログ: v2 実装では `structlog` に `agent_io_version="v2"` を付与し、可観測性を強化。
- テスト実行（Docker/バックエンド全テスト）:

```bash
docker compose up -d backend
docker compose exec -T backend pytest -q
```

### スケジュール案
- Day 1-2: パイロット + サービス呼び出し対応 + ユニット/統合テスト整備。
- Day 3: 残りエージェントへの適用完了。
- Day 4: 最終置換 PR、全テスト完了後にタグ付与と告知。

## 旧I/Fの非推奨とログシグナル（追加）

- 非推奨: 各エージェントの旧 `run()` ラッパーは非推奨。呼び出し時に警告ログを出力。
  - ログキー: `agent_legacy_run_deprecated`（`agent=general|python|manufacturing`）
- フォールバック検知: サービスで v2 が未登録の場合に旧I/Fへフォールバックした際に警告ログを出力。
  - ログキー: `agent_v1_fallback_used`（`agent` はバインド済み）
- 撤去予定: CI 安定後に `get_agent()` と旧 `run()` を削除し、`get_agent_v2()` のみを使用。

## CI での検証（要約）

- バックエンド: `pytest` + coverage（fail-under=80）
- フロントエンド: type-check + Jest coverage
- グラフ出力: `scripts/export_graph.py` と `scripts/render_graph_png.sh`（Mermaid CLI Docker）で `docs/graph.mmd` と `docs/graph.png` を生成・アップロード
- ログ検証: `agent_legacy_run_deprecated` と `agent_v1_fallback_used` の警告ログを確認

### ロギング検証の手順（開発・CI）

- 個別検証（カバレッジ無効化相当で addopts を上書き）
  ```bash
  docker compose up -d backend
  docker compose exec -T backend pytest -q -o addopts="" tests/test_legacy_deprecation_logs.py
  ```
- フルスイート（`backend/pytest.ini` 構成に準拠）
  ```bash
  docker compose exec -T backend pytest -q
  ```

### 統合テスト実行（Docker）

- 推奨スクリプト（バックエンド/フロントエンド/疎通をまとめて実行）
  ```bash
  docker compose up -d backend frontend
  NO_COV=1 sh scripts/run_integration_tests.sh   # 開発ループ向け（カバレッジ無効）
  sh scripts/run_integration_tests.sh            # カバレッジ有効（閾値チェック）
  ```

### グラフ出力（ローカル実行）

- まとめて生成（推奨）:
  ```bash
  sh scripts/generate_graph_assets.sh
  ```
- ビルトインPNGレンダラをスキップしてMermaid CLIへフォールバックする場合:
  ```bash
  FORCE_PNG_FALLBACK=1 sh scripts/generate_graph_assets.sh
  ```

#### トラブルシューティング

- Built-in PNG レンダラ失敗（例: mermaid.ink 502）
  - 症状: `export_mermaid_png()` 実行時に 5xx エラー
  - 対応: 自動で Mermaid CLI にフォールバック。明示的に回避する場合は `FORCE_PNG_FALLBACK=1` を設定
- GHCR からの Pull が拒否される（`ghcr.io/mermaid-js/mermaid-cli` denied）
  - 症状: 企業ネットワークやトークン要件で GHCR へのアクセスが拒否
  - 対応: スクリプトが自動で Docker Hub（`minlag/mermaid-cli`）へフォールバック
  - 事前回避: 事前に Docker Hub 画像を pull しておく

### 撤去の判断基準（Gate）

- CI で全テスト成功・カバレッジ >= 80% を継続的に満たす
- 運用/CI ログで `agent_v1_fallback_used` が一定期間ゼロ（例: 1週間）
- コードベースに旧I/F参照が残っていない（`get_agent()` の参照や旧 `run()` 呼び出しが無いことを確認）

### ログ監視（運用/CI）

- ローカル/運用（Docker）:
  ```bash
  docker compose logs backend -f | grep -E "agent_legacy_run_deprecated|agent_v1_fallback_used"
  ```
  例:
  - 旧I/F検知: `agent_legacy_run_deprecated`（`agent=...`）
  - フォールバック検知: `agent_v1_fallback_used`（`thread_id`・`agent`）

- CI（GitHub Actions）:
  - Actions 実行ログ内でキーワード検索: `agent_legacy_run_deprecated` / `agent_v1_fallback_used`
  - 失敗テストの出力や `pytest -q` のログ捕捉で本イベントが出ていないことを確認

### 撤去作業手順（実施時）

1. 旧I/Fラッパーの削除
   - 対象: `backend/app/services/agents/general_responder.py`、`python_mentor.py`、`manufacturing_advisor.py`
   - `run()`（v1ラッパー）を削除し、`run_v2(AgentInput) -> AgentOutput` のみを残す
2. サービス層のフォールバック削除
   - 対象: `backend/app/services/langgraph_service.py`
   - `_process_manufacturing_query()` / `_process_python_query()` / `_generate_general_response()` から `get_agent()` 参照と v1 フォールバック分岐・ログ（`agent_v1_fallback_used`）を削除
   - `get_agent_v2()` 未登録時はエラーにするか、CI 移行期間は明示的な例外メッセージに統一
3. レジストリの整理
   - 対象: `backend/app/services/agents/registry.py`
   - `get_agent()` を撤去し、`get_agent_v2()` のみを公開
4. テスト更新
   - 旧I/F専用テスト（例: `backend/tests/test_legacy_deprecation_logs.py`）を削除
   - v2 のみを前提としたカバレッジ維持を確認
   - `pytest -q` で全成功、カバレッジ >= 80% を継続
5. ドキュメント更新
   - 本セクションの「Gate」達成・撤去完了を記録
   - 既知の移行リスク/回避策を追記

補助コマンド（参照残の一括確認例）:
```bash
grep -R "get_agent(" backend/app -n || true
grep -R "def run(" backend/app/services/agents -n || true
```

 

# 公式に合わせたリファクタリング計画

- バージョン: 1.0.0
- 作成日: 2025-08-31
- 対象: Backend（LangGraphベースのワークフロー）
- 想定読者: 開発者・レビュアー

## 目的
LangGraph 公式ドキュメントに準拠した形で、拡張性（追加容易性）と視認性（可観測性・可視化の正確性）を高める。

## 現状サマリ
- エージェント: `backend/app/services/agents/` に 1ファイル=1エージェントを分離済み
  - `manufacturing_advisor.py`, `python_mentor.py`, `general_responder.py`
- LangGraph サービス: `langgraph_service.py` から上記エージェントへ委譲
- ツール: `backend/app/services/tools/` に分離、`detect.py`/`registry.py`/`sql.py`/`web.py`
- 統合テスト: Docker 内で 11/11 PASS（既存挙動維持）

## 進捗状況（最終更新: 2025-08-31 21:47 JST）

- 完了
  - 可視化: `export_mermaid()` を `get_graph().draw_mermaid()` へ移行（手動定義フォールバック維持）
  - エージェントI/F: `agents/types.py`（`AgentInput/Output`）＋ `agents/registry.py` 追加、サービスからレジストリ解決
  - ツールI/F: `ToolResult` 追加、`async_execute_tool()` によるタイムアウト/例外の構造化（`tools/registry.py`）
  - 状態管理: `messages: Annotated[list, add_messages]` を導入し、`user/assistant` を各終端ノードで追加
  - Durable: `Settings.enable_checkpointer` による `MemorySaver` 条件導入、`thread_id` を `ainvoke(configurable)` に伝播
  - PNG: `export_mermaid_png()`（ビルトイン）を追加し、`scripts/generate_graph_assets.sh` でビルトイン優先→Docker Mermaid CLI へフォールバック
  - ログ/相関ID: `thread_id`/`agent`/`tool` を `structlog` で各ノード・エラーに bind して一貫出力。`ManufacturingState` に `thread_id` を追加して状態として伝播。
  - テスト（Docker内ユニット）: messages reducer、async tools（timeout/error）、Durable（checkpointer+thread_id）スモーク、ログ相関ID（thread_id/agent/tool）の計5本を追加し PASS。
  - 命名整理: `ManufacturingState` → `WorkflowState` に移行（コード内は `WorkflowState` に統一、`ManufacturingState = WorkflowState` のエイリアスで後方互換維持）

- 次のステップ
  - CI最適化（任意）
    - バックエンドテスト（現在16ケース）と可視化エクスポートの検証をワークフローへ追加

## 公式に基づく改善ポイント
1. 可視化の一貫性（Mermaid のビルトイン利用）
   - 公式: `app.get_graph().draw_mermaid()` を推奨
   - 目的: グラフ定義と可視化のズレを防止
2. エージェントの標準I/F（Protocol + 型）
   - `AgentInput`/`AgentOutput`（Pydantic推奨）と `Agent` Protocol を導入
   - レジストリ `agents/registry.py` で名前→実装を解決
3. ツールの将来拡張（非同期・タイムアウト・構造化結果）
   - `async_execute_tool()` と `ToolResult`（`tool`, `input`, `output`, `took_ms`, `error?`）
4. 状態管理の強化（Reducer）
   - `messages: Annotated[list, add_messages]` で会話履歴を蓄積（段階移行）
5. Durable Execution（Checkpointer）
   - `compile(checkpointer=...)` ＋ `thread_id` 運用（長時間/失敗復帰/HITLに備える）
6. ロギング/トレーシングの強化
   - `request_id`/`session_id`/`agent`/`tool` など相関ID付帯
7. PNG生成の選択肢（任意）
   - `draw_mermaid_png()` によるCI単純化（現行のDocker版は継続可）
8. 命名の明確化（任意・段階的）
   - `ManufacturingState` → `WorkflowState`（エイリアス→置換）

## 実施手順（フェーズ）
### フェーズ1: 可視化の公式準拠（低リスク・先行）
- 修正: `LangGraphService.export_mermaid()` をビルトイン優先へ
  ```python
  def export_mermaid(self) -> str:
      try:
          return self._workflow.get_graph().draw_mermaid()
      except Exception:
          # 手動定義フォールバック（後方互換用）
          return "\n".join([...])
  ```
- スクリプト: `scripts/export_graph.py` は `service.export_mermaid()` を呼ぶため変更不要
- 受け入れ基準: 統合テスト PASS、`docs/graph.mmd` が最新トポロジと一致

#### グラフ可視化の実行方法（Docker推奨）
- 推奨: Docker上の backend コンテナ内で実行してください。

1) ワンコマンド（MermaidとPNGの両方生成）
```bash
sh scripts/generate_graph_assets.sh
```

2) 手動でMermaid生成のみ（backendコンテナ内実行）
```bash
docker compose up -d backend
docker compose exec -T backend python -c "from app.services.langgraph_service import LangGraphService; print(LangGraphService().export_mermaid())" > docs/graph.mmd
```

3) `scripts/export_graph.py` をコンテナ内で直接実行
```bash
docker compose exec -T backend python /app/scripts/export_graph.py
```

4) ローカル環境での代替（開発向け）
```bash
python3 -m venv .venv && source .venv/bin/activate
pip install -r backend/requirements.txt
python scripts/export_graph.py
```
注意: ローカル実行では依存関係（例: structlog）が必要です。Dockerを利用すると依存差異による失敗を避けられます。

### フェーズ2: エージェントI/F + レジストリ（中）
- 追加: `agents/types.py`（`AgentInput/Output` + Protocol）
- 追加: `agents/registry.py`（名前→エージェント解決）
- 更新: `langgraph_service.py` の `_process_*` はレジストリ経由で解決
- テスト: プロンプト生成/フォールバックのユニットテスト

### フェーズ3: ツール非同期化 + 構造化結果（中）
- 追加: `ToolResult`、`async_execute_tool()`、タイムアウト/例外の明示
- 更新: `_process_tool_query()` に `ToolResult` の扱いを導入
- テスト: タイムアウト/エラー経路のユニットテスト

### フェーズ4: 状態・耐障害性・可観測性（低〜中）
- 状態: `messages: Annotated[list, add_messages]`（段階移行）
- Durable: `MemorySaver` などのチェックポインタ導入（任意）
- ログ: 相関IDの全体付帯（agents/tools/service）
- PNG: 必要なら `draw_mermaid_png()` に切替（任意）

#### Durable Execution 有効化（任意）
- 設定: `.env` または環境変数で `ENABLE_CHECKPOINTER=true` 相当（`Settings.enable_checkpointer`）。
- 実装: `LangGraphService._build_workflow()` で `workflow.compile(checkpointer=MemorySaver())` を条件付き適用。
- 呼出: `process_manufacturing_query(..., thread_id=session_id)` のように `thread_id` を `ainvoke(config={"configurable": {"thread_id": ...}})` に伝播。
- 目的: 長時間処理・再開・HITL（人間介在）に備えた耐障害性の向上。

#### PNG 生成フロー（CI/ローカル共通）
- スクリプト: `scripts/generate_graph_assets.sh`
- 手順: 
  1) Mermaid（`.mmd`）は backend コンテナ内で `LangGraphService.export_mermaid()` を実行して生成
  2) PNG はまず backend コンテナ内で `export_mermaid_png()`（ビルトイン）を試行
  3) 失敗または空出力の場合のみ Docker の Mermaid CLI (`render_graph_png.sh`) にフォールバック
- 目的: 公式のビルトインレンダラを優先してグラフの実体と整合を取りつつ、環境依存で失敗しても確実に PNG を得る

## 受け入れ基準
- 既存統合テスト（11件）および追加ユニットテストが全て PASS
- 可視化（Mermaid/PNG）がグラフの実体と常に一致
- 新規エージェント/ツール追加が最小差分で完結（レジストリ/型に準拠）

## 変更対象の主なファイル/ディレクトリ
- `backend/app/services/langgraph_service.py`
- `backend/app/services/agents/`（`types.py`, `registry.py`, 既存エージェント）
- `backend/app/services/tools/`（`ToolResult`, 非同期化）
- `scripts/export_graph.py`（基本変更不要）

## 参考リンク（LangGraph 公式）
- Graph API 可視化（Mermaid/PNG）: 
  - https://langchain-ai.github.io/langgraph/how-tos/graph-api/ （Visualize your graph）
- State / Reducer / TypedDict: 
  - https://langchain-ai.github.io/langgraph/how-tos/graph-api/ （Define and update state）
- Durable Execution / Persistence / Checkpoints: 
  - https://langchain-ai.github.io/langgraph/concepts/durable_execution/
  - https://langchain-ai.github.io/langgraph/concepts/persistence/
  - https://langchain-ai.github.io/langgraph/reference/checkpoints/

## ロールバック戦略
- すべて段階導入・後方互換ラッパーを維持
- 問題発生時は該当フェーズの変更のみ巻き戻し

## メモ
- 現行構成はすでに良好。上記は中長期の保守性/拡張性/視認性向上が目的

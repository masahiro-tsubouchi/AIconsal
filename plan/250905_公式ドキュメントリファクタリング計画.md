# 250905_公式ドキュメントリファクタリング計画

> バージョン: 1.0.0  
> 作成日: 2025-09-05  
> 対象: LangGraph 公式準拠における「判定OK以外」の改善項目（ストリーミング、ブレークポイント/サブグラフ、メッセージ型の厳密化）  
> 想定読者: 開発者 / レビュアー / QA

## 1. ゴール
- 公式ドキュメント（Graph API / Streaming / Durable Execution / Breakpoints）のベストプラクティスに整合。
- 既存挙動（非デバッグ時）を一切壊さずに、デバッグ/運用性を段階的に強化。
- Docker専用テスト運用（Jest 非対話、NO_COV トグル）を維持。

## 2. 対象範囲（判定OK以外）
- ストリーミング（イベント/トークン）: Deferred → 本計画で導入提案
- ブレークポイント / サブグラフ: Deferred → 本計画で導入提案
- メッセージ型の厳密化（`AIMessage/HumanMessage` 等）: 任意 → 本計画で段階導入提案

## 3. 現状と課題
- 現状: `ainvoke` による単発応答。`decision_trace` は蓄積し REST 応答に同梱、WS は通常メッセージのみ。
- 課題: ランタイム中の可視化（逐次イベント）・停止/再開・メッセージ型の型安全性（テスト支援）が未対応。

## 4. 方針（非破壊・段階導入）
- フラグ駆動（既定OFF）：`DEBUG_STREAMING=1` / `DEBUG_BREAKPOINTS=1` など。
- まずはデバッグ用途（開発者向け）に限定して導入 → 安定後に運用向け拡張を検討。
- すべて Docker 内でテスト（バックエンド/フロント/統合）。

## 5. 実施手順（フェーズ）
### フェーズA: イベントストリーミング（Debug限定）
- Backend（`backend/app/services/langgraph_service.py`）
  - 追加: `async def stream_events(...):` を実装し、`self._workflow.astream_events(initial_state, config=...)` を使用。
  - 入力: `debug=True` かつ `DEBUG_STREAMING=1` のときのみ有効。
  - 出力: `{"type":"debug_event","data":{"event_type":"node_start|node_end|tool|...","ts":...,"payload":{...}}}`
- API（`backend/app/api/v1/chat.py` 想定）
  - 追加: `WS /api/v1/chat/ws/{session_id}?debug_streaming=1`（既存WSと同一パスでも可、クエリで切替）。
  - `debug_event` を逐次送信。最終メッセージは既存の `message` として送出（互換保持）。
- Frontend（`frontend/src/hooks/useWebSocket.ts` など）
  - 追加: `type === "debug_event"` の受信ブランチ。とりあえずは開発者用の簡易パネル（コンソール、もしくはデバッグトースト）に流す。
  - 既存の `message`/`status`/`error` には影響を与えない。
- 受け入れ基準
  - `debug_streaming=1` で `debug_event` が受信できる（E2E）。
  - 既定（OFF）では挙動が一切変わらない。
  - セキュリティ: 個人情報/秘密情報を `payload` に含めないこと（テストで検証）。

### フェーズB: ブレークポイント / サブグラフ（開発者向け）
- Backend（`langgraph_service.py`）
  - 追加: `DEBUG_BREAKPOINTS=1` の時、`analyze_query` ノード開始時にブレークポイント（イベント `breakpoint_hit`）を emit。
  - 任意: `process_tool` を小規模サブグラフ化してモジュール性を向上（将来のツール拡張に備える）。
- API / UX
  - ブレークポイントはデバッグストリーム経由で表示、もしくはログ出力のみ（初期段階）。
  - 将来: ブレークポイント解除の操作（コマンド/WSメッセージ）を検討。
- 受け入れ基準
  - フラグON時に `breakpoint_hit` がイベントとして観測可能。
  - グラフは引き続き正常にコンパイル/可視化できる（`scripts/generate_graph_assets.sh` で検証）。

### フェーズC: メッセージ型の厳密化（任意・段階導入）
- Backend
  - 現状: `messages: List[dict]` を `add_messages` で蓄積。
  - 段階導入: `langchain_core.messages` の `HumanMessage/AIMessage` を内側の実装で採用しつつ、外部I/Fは一旦既存のまま（互換維持）。
  - コンバータ: `List[dict]` ↔ 型付きメッセージの相互変換ヘルパを用意。
- Frontend
  - 影響なし（バックエンド境界で正規化）。
- 受け入れ基準
  - 既存APIのレスポンス形は不変。
  - 型導入によりユニットテストの可読性/保守性が向上（テストコードで検証）。

## 6. テスト戦略（Docker専用）
- Backend: `pytest`（カバレッジ >= 80%、`backend/pytest.ini` 準拠）。
  - A: `stream_events` のユニット/統合（WS）テスト追加。
  - B: ブレークポイントイベントの発火/無効化テスト。
  - C: メッセージ型コンバータの単体テスト。
- Frontend: Jest（非対話 `--watchAll=false`）。
  - A: `debug_event` 受信時のハンドリング（最低限: ログ/簡易表示）。
- Integration: `scripts/run_integration_tests.sh` にストリーミング検証を追加（必要なら `NO_COV=1` ルートも維持）。

## 7. ドキュメント更新
- `docs/api_reference.md`: `WS debug_streaming` のクエリ/ペイロード例を追記。
- `docs/debug_trace.md`: ストリーミングイベント例・セキュリティ注意を追記。
- `docs/development/backend_guide.md`: `astream_events`/ブレークポイント/サブグラフの設計メモを追記。
- `docs/development/frontend_guide.md`: `debug_event` 受信分岐の最小例を追記。

## 8. セキュリティ/プライバシー
- デバッグイベントにユーザー入力全文を含めない（要約/トリム）。
- 機密トークン/APIキーは絶対に含めない。
- ログ/イベントは開発者向け機能（フラグON時）に限定し、既定はOFF。

## 9. 影響・リスク・ロールバック
- 影響: 既定OFFのため本番挙動に影響なし。
- リスク: ストリーミングでのイベント洪水 → フィルタ/サンプリングを導入可能。
- ロールバック: フラグ無効化で機能全体を停止。コードは変更加えても既存分岐（非ストリーム）を維持。

## 10. スケジュール目安
- フェーズA（ストリーミング）: 0.5〜1.0日
- フェーズB（ブレークポイント/サブグラフ）: 0.5〜1.0日
- フェーズC（メッセージ型厳密化・内部）: 0.5日

## 11. 受け入れ基準（総合）
- 既定（フラグOFF）で全テスト PASS（カバレッジ >= 80%）。
- `debug_streaming=1` で `debug_event` を受信（統合テストで検証）。
- `DEBUG_BREAKPOINTS=1` で `breakpoint_hit` を観測。グラフのMermaid/PNGが更新され、整合。

## 12. 参考リンク（LangGraph 公式）
- Graph API / 可視化 / 状態: https://langchain-ai.github.io/langgraph/how-tos/graph-api/
- Durable Execution / Persistence / Checkpoints:
  - https://langchain-ai.github.io/langgraph/concepts/durable_execution/
  - https://langchain-ai.github.io/langgraph/concepts/persistence/
  - https://langchain-ai.github.io/langgraph/reference/checkpoints/
- Streaming（概念/実装）:
  - https://langchain-ai.github.io/langgraph/concepts/streaming/
  - https://langchain-ai.github.io/langgraph/how-tos/streaming/
  - Debug イベント: https://langchain-ai.github.io/langgraph/cloud/how-tos/stream_debug/
